

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      
        LFE OTP: Creating Servers with the gen_server Behaviour -
      
      LFE Tutorials, News, &amp; Updates
    </title>
    <meta name="description" content="Creating a generic OTP server in LFE">
    <meta name="author" content="LFEuminati | Alien Alliance">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/hooligan/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/assets/themes/hooligan/css-social-buttons/css/zocial.stripped.css">
    <link href="/assets/themes/hooligan/css/pygments.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/darkstrap.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/hooligan/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/css/twilight.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/css/overrides.css" rel="stylesheet" type="text/css" media="all">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="LFE News & Updates Atom Feed">
    <link rel="shortcut icon" href="/assets/images/favicon.ico">
    <!-- fav and touch icons -->
    <!-- Update these with your own images
      <link rel="apple-touch-icon" href="assets/images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="assets/images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="assets/images/apple-touch-icon-114x114.png">
    -->
  </head>

  <body>
    <div id="page-wrap">
      <div class="navbar">
        <div class="navbar-inner">
          <div class="container">
            <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </a>

	    <a class="brand" href="/"><img style="float: left; padding-right: 8px;" src="/assets/images/LispFlavoredErlang-xtinsy.png" /> LFE Tutorials, News, &amp; Updates</a>

            <div class="nav-collapse">
              <ul class="nav">
                
                
                


  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/authors.html">Authors</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  



		<li><a href="http://docs.lfe.io/">Docs</a></li>
		<li><a href="http://lfe.io/">lfe.io</a></li>
              </ul>
              <ul class="nav pull-right social visible-desktop">
                <li class="divider-vertical"></li>
                
                <li>
                  <a href="http://webchat.freenode.net/?channels=erlang-lisp" style="color: #999; font-size: 180%; margin-top: 3px;" target="_blank">
                    <span class=""> #</span>
                  </a>
                </li>
                
                
                <li>
                  <a href="https://github.com/lfe" class="zocial github icon" target="_blank">
                    <span class="hidden-desktop">Github</span>
                  </a>
                </li>
                
                
                <li>
                  <a href="https://plus.google.com/u/1/communities/103919485468949397234" class="zocial googleplus icon" target="_blank">
                    <span class="hidden-desktop">Google+</span>
                  </a>
                </li>
                
                
                <li>
                  <a href="https://twitter.com/ErlangLisp" class="zocial twitter icon" target="_blank">
                    <span class="hidden-desktop">Twitter</span>
                  </a>
                </li>
                
                
                
                
                <li>
                  <a href="http://feeds.feedburner.com/lfe/news-and-updates" class="zocial rss icon" target="_blank">
                    <span class="hidden-desktop">FeedBurner</span>
                  </a>
                </li>
                
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="content">
          

<div class="page-header">
  <h1>
    LFE OTP: Creating Servers with the gen_server Behaviour
    
  </h1>
</div>

<div class="row">
  <div class="span8">
    
<p><a href="/assets/images/posts/LFE-signal.jpg"><img class="right thumb" src="/assets/images/posts/LFE-signal.jpg" /></a>As mentioned in the previous
post, one of the most common patterns that was identified in Erlang was the
need to create a generic, long running process. This pattern has been codified
in the gen_server behaviour, and it is now time that we got our hands dirty by
creating a few :-)</p>

<h2 id="lfe-otp-tutorial-series">LFE OTP Tutorial Series</h2>

<ul>
  <li><a href="/tutorials/2015/05/23/1720-new-series-lfe-otp-tutorials/">Introducing the LFE OTP Tutorials</a></li>
  <li><a href="/tutorials/2015/05/24/1808-what-is-otp/">What is OTP?</a></li>
  <li><a href="/tutorials/2015/05/25/0929-prelude-to-otp/">Prelude to OTP</a></li>
  <li><a href="/tutorials/2015/05/26/1112-creating-servers-with-the-gen_server-behaviour/">Creating Servers with the gen_server Behaviour</a></li>
</ul>

<p>You can leave feedback for the LFE OTP tutorials
<a href="https://github.com/lfe/blog/issues/7">here</a>.</p>

<h2 id="in-this-post">In This Post</h2>

<ul>
  <li>Requirements, Assumptions, and Code</li>
  <li>Introductory Notes on <code>gen_server</code></li>
  <li>Creating a Callback Module</li>
  <li>Creating a Server Module</li>
  <li>Creating An API</li>
  <li>Updating An API</li>
  <li>Full Source Code</li>
  <li>Learning More About gen_server</li>
  <li>Up Next</li>
  <li>Footnotes</li>
</ul>

<h2 id="requirements-assumptions-and-code">Requirements, Assumptions, and Code</h2>

<p>Before reading this tutorial, be sure you should have read the ones preceding
it in this series. For a list of what you need to have installed before working
through the examples as well as getting the source code for these tutorials,
please see the post <a href="/tutorials/2015-05-25-0929-prelude-to-otp/">Prelude to OTP</a>.</p>

<h2 id="introductory-notes-on-genserver">Introductory Notes on gen_server</h2>

<p>The <code>gen_server</code> behaviour defines a contract between the programmer and the
world of OTP, expecting you to do the following:</p>

<ul>
  <li>Define a module which implements <code>gen_server</code> functions</li>
  <li>Define a callback module which implements the required message-passing (and
callback-related) functions</li>
</ul>

<p>If you have ever looked at Erlang code for <code>gen_server</code>s, you will have
noticed that setting up a <code>gen_server</code> involves some boilerplate Erlang data
structures.  This sort of setup is a common idiom in Erlang, however, the
approach is a bit atypical for a Lisp. It’s more common to see keyword
arguments (a la <code>&amp;key</code>) or even property lists in Common Lisp. In Clojure,
hash maps are used to the same effect.</p>

<p>When creating new functions in LFE, you have the option of providing a better
developer experience by simulating keyword arguments using such things as the
new map data type, property lists, or records. Since we are using functions
which already exist in OTP, we don’t have that option (unless we create
wrappers or define an OTP DSL … but that’s out of scope for this series!).
Instead, we’ll simply take extra measures for clarity, defining variables with
names that give strong hints as to how they will be used by the <code>gen_server</code>
code.</p>

<p>Furthermore, it is a very common practice in Erlang for developers to implement
a behaviour module and a callback module in the same file. This has a tendency
to confuse newcomers, so we have opted for an explicit separation of the two in
order to make the delineation of responsibilities as clear as possible.</p>

<p>That said, we’re ready for some code!</p>

<h2 id="creating-a-callback-module">Creating a Callback Module</h2>

<p>If we want to port our previous closure or process example servers to use OTP,
it might made the most sense to start with the callback module, since this is
where most of the logic lives:</p>

<div class="highlight"><pre><code class="language-lisp"><span class="p">(</span><span class="nb">defun</span> <span class="nv">handle_cast</span>
  <span class="p">((</span><span class="ss">&#39;add</span> <span class="nv">state-data</span><span class="p">)</span>
    <span class="o">`#(</span><span class="nv">noreply</span> <span class="o">,</span><span class="p">(</span><span class="nb">+</span> <span class="mi">1</span> <span class="nv">state-data</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">handle_call</span>
  <span class="p">((</span><span class="ss">&#39;amount</span> <span class="nv">_caller</span> <span class="nv">state-data</span><span class="p">)</span>
    <span class="o">`#(</span><span class="nv">reply</span> <span class="o">,</span><span class="nv">state-data</span> <span class="o">,</span><span class="nv">state-data</span><span class="p">))</span>
  <span class="p">((</span><span class="nv">message</span> <span class="nv">_caller</span> <span class="nv">state-data</span><span class="p">)</span>
    <span class="o">`#(</span><span class="nv">reply</span> <span class="o">,</span><span class="p">(</span><span class="nv">unknown-command</span><span class="p">)</span> <span class="o">,</span><span class="nv">state-data</span><span class="p">)))</span></code></pre></div>

<p>If we compare this to the process server from the previous post, we can see
that things have started to change rather significantly:</p>

<div class="highlight"><pre><code class="language-lisp"><span class="p">(</span><span class="nb">defun</span> <span class="nv">process-state</span> <span class="p">(</span><span class="nv">caller</span> <span class="nv">state-data</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">receive</span>
    <span class="p">(</span><span class="ss">&#39;add</span>
      <span class="p">(</span><span class="nv">process-state</span> <span class="nv">caller</span> <span class="p">(</span><span class="nb">+</span> <span class="mi">1</span> <span class="nv">state-data</span><span class="p">)))</span>
    <span class="p">(</span><span class="ss">&#39;amount?</span>
        <span class="p">(</span><span class="nv">!</span> <span class="nv">caller</span> <span class="nv">state-data</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">process-state</span> <span class="nv">caller</span> <span class="nv">state-data</span><span class="p">))))</span></code></pre></div>

<p>First of all, our callback module has two functions instead of just one:
<code>handle_cast</code> and <code>handle_call</code>. These functions are not used by developers
or users of the OTP software we write; they are defined in a callback module
for use by our <code>gen_server</code>.</p>

<p>The <code>handle_call</code> function is used for making synchronous calls, usually
where a result is expected. This is why we return the <code>#(reply ...)</code> tuple:
we’re letting OTP know that whatever made this call should get the second
element of the tuple sent to it. The third element of the tuple is used
internally by <code>gen_server</code> as the state data which restarts the loop after
this call (all under the hood and away from view). We did something almost
identical in our process example in the last post. In this simple example, our
return value and our state data are one and the same; in a more complicated
example, one might extract the result from the state data or perform some
operations on the state data. Whatever you did, you would put the result you
wanted to be sent back to the caller in the second element of the tuple.</p>

<p>Note the reply of <code>(unknown-command)</code> in the catch-all function head pattern
for <code>handle_call</code>. This is used here for demonstration purposes only. In a
later post, we will cover error handling and how to best deal with unexpected
messages in an OTP application. <sup id="fnref:handle-info"><a href="#fn:handle-info" class="footnote">1</a></sup></p>

<p>The <code>handle_cast</code> function is used for making asynchronous calls, often
convenient when you want to execute a function and don’t care about returning
data to the caller. This is exactly what we’re using it for: we just want our
state data to get incremented; we don’t want a result. <sup id="fnref:delayed-result"><a href="#fn:delayed-result" class="footnote">2</a></sup></p>

<p>Both functions expect a message (any Erlang term) and the state data for our
<code>gen_server</code> loop. Additionally, the <code>handle_call</code> function takes a
parameter for the calling function so that it can send results back to it. When
we look at the the API code in our server module, we’ll see where this code
gets called.  First, though, let’s finish looking at our callback module:</p>

<p>The other thing our callback module needs to define is an <code>init</code> function.
This is used to “prime the pump”, as it were, for the the <code>gen_server</code> loop.
In other words, this is what initializes the state that gets passed to the
various <code>handle_*</code> functions. Note that for our example, our state data is
extremely simple: it’s just an integer. But it could be any LFE data structure,
including records (which is very often what the state data is in Erlang and LFE
applications).</p>

<h2 id="creating-a-server-module">Creating a Server Module</h2>

<p>Okay, so we know how our logic gets converted from the non-OTP server loops to
the callback code … but what calls the callback? If we’re creating a server
in this post then where is the server code? Thanks to OTP (which takes care of
so many of the details), our server code is very simple:</p>

<div class="highlight"><pre><code class="language-lisp"><span class="p">(</span><span class="nb">defun</span> <span class="nv">start</span> <span class="p">()</span>
  <span class="p">(</span><span class="nv">gen_server:start</span> <span class="p">(</span><span class="nv">register-name</span><span class="p">)</span>
                    <span class="p">(</span><span class="nv">callback-module</span><span class="p">)</span>
                    <span class="p">(</span><span class="nv">initial-state</span><span class="p">)</span>
                    <span class="p">(</span><span class="nv">genserver-opts</span><span class="p">)))</span></code></pre></div>

<p>As promised above, instead of archane data structures, we have very clearly
defined the variables which are being used as the <code>gen_server:start</code>
arguments:</p>

<ol>
  <li>The <code>start/4</code> function takes a name with which the server will be
  registered. <sup id="fnref:start-name"><a href="#fn:start-name" class="footnote">3</a></sup> The name is a tuple with the first element being
  either <code>local</code> or <code>global</code> and the second being the actual name for the
  process. <sup id="fnref:via-name"><a href="#fn:via-name" class="footnote">4</a></sup></li>
  <li>The second argument is the callback module associated with this server
  (that’s what we created in the previous section … it’s where all our logic
  lives).</li>
  <li>In our case, the next argument is the initial state for our server loop, but
more generally, it is the list of arguments (can be an empty list) that will
be passed to the <code>init</code> function in a <code>gen_server</code>’s callback module.</li>
  <li>Finally, if we want to pass any options to the <code>gen_server</code> process
itself, we can do that here. At the beginning of the module where this code
lives, we’ve defined <code>(genserver-opts)</code> to be an empty list, since we
don’t need to do anything special here. <sup id="fnref:genserver-opts"><a href="#fn:genserver-opts" class="footnote">5</a></sup></li>
</ol>

<p>As you can see, there are a series of functions being called that we haven’t
defined above – these are all defined in the tutorial server module
<code>tut01.lfe</code> (the full listing of which is at the end of this post). These
hold all the data which is getting passed. <sup id="fnref:genserver-args"><a href="#fn:genserver-args" class="footnote">6</a></sup></p>

<h2 id="creating-an-api">Creating An API</h2>

<p>Next, we can look at our API. As you recall from the last post, our “APIs” were
hardly that. They consisted of making <code>funcall</code>s in one case, and in the
other, sending messages to the server process via the <code>(! ...)</code> form. That
changes now :-)</p>

<p>Whenever you have created an implementation of the <code>gen_server</code> behaviour and
a callback module for it, the way you execute the callback code is by sending
messages to your server via <code>(gen_server:call ...)</code> and <code>(gen_server:cast
...)</code>. We will use these to define a nicely usable API for our server:</p>

<div class="highlight"><pre><code class="language-lisp"><span class="p">(</span><span class="nb">defun</span> <span class="nv">add</span> <span class="p">()</span>
  <span class="p">(</span><span class="nv">gen_server:cast</span> <span class="p">(</span><span class="nv">server-name</span><span class="p">)</span> <span class="ss">&#39;add</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">amount?</span> <span class="p">()</span>
  <span class="p">(</span><span class="nv">gen_server:call</span> <span class="p">(</span><span class="nv">server-name</span><span class="p">)</span> <span class="ss">&#39;amount</span><span class="p">))</span></code></pre></div>

<p>You can imagine that for a large server module, there would be a great many API
functions defined here. At this point, the mystery of what calls
our <code>handle_cast</code> and <code>handle_call</code> functions in the callback module is
solved :-)</p>

<p>OTP helps us to also keep our API definitions very simple. Essentially we’re
saying “Hey, gen_server!  You know that server we defined called
<code>(server-name)</code>? Well, we’d like to send a <code>cast</code> message to it. Can you do
that please?” OTP then takes care of the rest of it for us, by looking up the
server, finding the callback module that was defined for it, and then calling
the <code>handle_cast</code> function with the appropriate arguments.</p>

<p>Let’s try it out:</p>

<div class="highlight"><pre><code class="language-bash"><span class="nv">$ </span><span class="nb">cd</span> ../tut01
<span class="nv">$ </span>make repl</code></pre></div>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">tut01:start</span><span class="p">)</span>
<span class="o">#(</span><span class="nv">ok</span> <span class="nv">&lt;0.35.0&gt;</span><span class="p">)</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">tut01:add</span><span class="p">)</span>
<span class="nv">ok</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">tut01:add</span><span class="p">)</span>
<span class="nv">ok</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">tut01:amount?</span><span class="p">)</span>
<span class="mi">2</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">tut01:add</span><span class="p">)</span>
<span class="nv">ok</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">tut01:amount?</span><span class="p">)</span>
<span class="mi">3</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">gen_server:call</span> <span class="p">(</span><span class="nv">tut01:server-name</span><span class="p">)</span> <span class="ss">&#39;bingo</span><span class="p">)</span>
<span class="o">#(</span><span class="nb">error</span> <span class="s">&quot;Unknown command.&quot;</span><span class="p">)</span></code></pre></div>

<p>How’s <em>that</em> for clean! That’s what a good developer experience should look
like :-) None of this crazy you-gotta-make-<code>funcall</code>s-and-then-save-state
business.</p>

<p>Let’s review what happened above:
We started up our server which initialized the loop with the data we
configured for it in our server module (just the integer <code>0</code> in our case).
Next, we made some API calls which were passed on to our callback module by the
underlying OTP infrastructure. We got results for our API functions which made
<code>call</code>s, and for the <code>cast</code>s we got a simple and reassuring <code>ok</code>.  When
skipping the API functions and making calls directly via <code>gen_server:call</code>,
we got the expected error message for messages which don’t match the ones that
have been defined in our callback module.</p>

<h2 id="updating-an-api">Updating An API</h2>

<p>What if we needed to make a change to our API? Asked another way, what does one
need to do in order to add new functionality to a server API? Let’s answer this
by looking at a special case: adding the ability to stop our server. We’ll
start with the new API function:</p>

<div class="highlight"><pre><code class="language-lisp"><span class="p">(</span><span class="nb">defun</span> <span class="nv">stop</span> <span class="p">()</span>
  <span class="p">(</span><span class="nv">gen_server:call</span> <span class="p">(</span><span class="nv">server-name</span><span class="p">)</span> <span class="ss">&#39;stop</span><span class="p">))</span></code></pre></div>

<p>That’s the easy bit. Now let’s add support for this new <code>stop</code> message to our
<code>handle_call</code> callback function:</p>

<div class="highlight"><pre><code class="language-lisp"><span class="p">(</span><span class="nb">defun</span> <span class="nv">handle_call</span>
  <span class="p">((</span><span class="ss">&#39;amount</span> <span class="nv">_caller</span> <span class="nv">state-data</span><span class="p">)</span>
    <span class="o">`#(</span><span class="nv">reply</span> <span class="o">,</span><span class="nv">state-data</span> <span class="o">,</span><span class="nv">state-data</span><span class="p">))</span>
  <span class="p">((</span><span class="ss">&#39;stop</span> <span class="nv">_caller</span> <span class="nv">state-data</span><span class="p">)</span>
    <span class="o">`#(</span><span class="nv">stop</span> <span class="nv">shutdown</span> <span class="nv">ok</span> <span class="nv">state-data</span><span class="p">))</span>
  <span class="p">((</span><span class="nv">message</span> <span class="nv">_caller</span> <span class="nv">state-data</span><span class="p">)</span>
    <span class="o">`#(</span><span class="nv">reply</span> <span class="o">,</span><span class="p">(</span><span class="nv">unknown-command</span><span class="p">)</span> <span class="o">,</span><span class="nv">state-data</span><span class="p">)))</span></code></pre></div>

<p>If we now try to run our server with just this change to the callback, we’d get
an error after calling our new <code>(tut01:stop)</code> API function that would look
something like this:</p>

<div class="highlight"><pre><code class="language-erlang"><span class="o">=</span><span class="nv">ERROR</span> <span class="nv">REPORT</span><span class="o">====</span> <span class="mi">25</span><span class="o">-</span><span class="nv">May</span><span class="o">-</span><span class="mi">2015</span><span class="p">::</span><span class="mi">19</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">16</span> <span class="o">===</span>
<span class="o">**</span> <span class="nv">Generic</span> <span class="n">server</span> <span class="n">tut01</span> <span class="n">terminating</span>
<span class="o">**</span> <span class="nv">Last</span> <span class="n">message</span> <span class="n">in</span> <span class="n">was</span> <span class="n">stop</span>
<span class="o">**</span> <span class="nv">When</span> <span class="nv">Server</span> <span class="n">state</span> <span class="o">==</span> <span class="n">&#39;state-data&#39;</span>
<span class="o">**</span> <span class="nv">Reason</span> <span class="n">for</span> <span class="n">termination</span> <span class="o">==</span>
<span class="o">**</span> <span class="p">{</span><span class="n">&#39;function not exported&#39;</span><span class="p">,</span>
       <span class="p">[{</span><span class="n">&#39;tut01-callback&#39;</span><span class="p">,</span><span class="n">terminate</span><span class="p">,...},</span>
        <span class="p">{</span><span class="n">gen_server</span><span class="p">,</span><span class="n">try_terminate</span><span class="p">,...},</span>
        <span class="p">{</span><span class="n">gen_server</span><span class="p">,</span><span class="n">terminate</span><span class="p">,</span><span class="mi">7</span><span class="p">,...},</span>
        <span class="p">{</span><span class="n">gen_server</span><span class="p">,</span><span class="n">handle_msg</span><span class="p">,</span><span class="mi">5</span><span class="p">,...},</span>
        <span class="p">{</span><span class="n">proc_lib</span><span class="p">,</span><span class="n">init_p_do_apply</span><span class="p">,</span><span class="mi">3</span><span class="p">,...}]}</span></code></pre></div>

<p>You will see that error message when you haven’t defined the <code>terminate</code>
callback function. Here’s a quick one:</p>

<div class="highlight"><pre><code class="language-lisp"><span class="p">(</span><span class="nb">defun</span> <span class="nv">terminate</span> <span class="p">(</span><span class="nv">_reason</span> <span class="nv">_state-data</span><span class="p">)</span>
  <span class="ss">&#39;ok</span><span class="p">)</span></code></pre></div>

<p>Now when we stop our server using our new API, we have success:</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">tut01:start</span><span class="p">)</span>
<span class="o">#(</span><span class="nv">ok</span> <span class="nv">&lt;0.35.0&gt;</span><span class="p">)</span>
<span class="nb">&gt;</span> <span class="p">(</span><span class="nv">tut01:stop</span><span class="p">)</span>
<span class="nv">ok</span></code></pre></div>

<p>And we can demonstrate that it’s really stopped by trying to call our
<code>amount?</code> API function:</p>

<div class="highlight"><pre><code class="language-lisp"><span class="nb">&gt;</span> <span class="p">(</span><span class="nv">tut01:amount?</span><span class="p">)</span>
<span class="nv">exception</span> <span class="nv">exit:</span> <span class="o">#(</span><span class="nv">noproc</span> <span class="o">#(</span><span class="nv">gen_server</span> <span class="nv">call</span> <span class="p">(</span><span class="nv">tut01</span> <span class="nv">amount</span><span class="p">)))</span>
  <span class="nv">in</span> <span class="nv">gen_server:call/2</span> <span class="p">(</span><span class="nv">gen_server.erl,</span> <span class="nv">line</span> <span class="mi">182</span><span class="p">)</span></code></pre></div>

<p>This was a special case; most times you will add API functions, there will be
no implicit execution of callback functions (which need to be defined in order
to prevent errors from being generated). Usually all you’ll have to do is
define your API function and then implement the logic that will get executed by
the callback module.</p>

<h2 id="full-source-code">Full Source Code</h2>

<p>Though we have this code defined in modules for this post’s tutorial in the
repository, it can be nice to see it on the page in the same context as the
blog post.</p>

<p>Here is the server module:</p>

<div class="highlight"><pre><code class="language-lisp"><span class="p">(</span><span class="nv">defmodule</span> <span class="nv">tut01</span>
  <span class="p">(</span><span class="nv">behaviour</span> <span class="nv">gen_server</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">export</span> <span class="nv">all</span><span class="p">))</span>

<span class="c1">;;; config functions</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">server-name</span> <span class="p">()</span> <span class="p">(</span><span class="nv">MODULE</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">callback-module</span> <span class="p">()</span> <span class="ss">&#39;tut01-callback</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">initial-state</span> <span class="p">()</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">genserver-opts</span> <span class="p">()</span> <span class="o">&#39;</span><span class="p">())</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">register-name</span> <span class="p">()</span> <span class="o">`#(</span><span class="nv">local</span> <span class="o">,</span><span class="p">(</span><span class="nv">server-name</span><span class="p">)))</span>

<span class="c1">;;; gen_server implementation</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">start</span> <span class="p">()</span>
  <span class="p">(</span><span class="nv">gen_server:start</span> <span class="p">(</span><span class="nv">register-name</span><span class="p">)</span>
                    <span class="p">(</span><span class="nv">callback-module</span><span class="p">)</span>
                    <span class="p">(</span><span class="nv">initial-state</span><span class="p">)</span>
                    <span class="p">(</span><span class="nv">genserver-opts</span><span class="p">)))</span>

<span class="c1">;;; our server API</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">add</span> <span class="p">()</span>
  <span class="p">(</span><span class="nv">gen_server:cast</span> <span class="p">(</span><span class="nv">server-name</span><span class="p">)</span> <span class="ss">&#39;add</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">amount?</span> <span class="p">()</span>
  <span class="p">(</span><span class="nv">gen_server:call</span> <span class="p">(</span><span class="nv">server-name</span><span class="p">)</span> <span class="ss">&#39;amount</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">stop</span> <span class="p">()</span>
  <span class="p">(</span><span class="nv">gen_server:call</span> <span class="p">(</span><span class="nv">server-name</span><span class="p">)</span> <span class="ss">&#39;stop</span><span class="p">))</span></code></pre></div>

<p>And here’s the callback module code:</p>

<div class="highlight"><pre><code class="language-lisp"><span class="p">(</span><span class="nv">defmodule</span> <span class="nv">tut01-callback</span>
  <span class="p">(</span><span class="nb">export</span> <span class="nv">all</span><span class="p">))</span>

<span class="c1">;;; config functions</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">unknown-command</span> <span class="p">()</span> <span class="o">#(</span><span class="nb">error</span> <span class="s">&quot;Unknown command.&quot;</span><span class="p">))</span>

<span class="c1">;;; callback implementation</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">init</span> <span class="p">(</span><span class="nv">initial-state</span><span class="p">)</span>
  <span class="o">`#(</span><span class="nv">ok</span> <span class="o">,</span><span class="nv">initial-state</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">handle_cast</span>
  <span class="p">((</span><span class="ss">&#39;add</span> <span class="nv">state-data</span><span class="p">)</span>
    <span class="o">`#(</span><span class="nv">noreply</span> <span class="o">,</span><span class="p">(</span><span class="nb">+</span> <span class="mi">1</span> <span class="nv">state-data</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">handle_call</span>
  <span class="p">((</span><span class="ss">&#39;amount</span> <span class="nv">_caller</span> <span class="nv">state-data</span><span class="p">)</span>
    <span class="o">`#(</span><span class="nv">reply</span> <span class="o">,</span><span class="nv">state-data</span> <span class="o">,</span><span class="nv">state-data</span><span class="p">))</span>
  <span class="p">((</span><span class="ss">&#39;stop</span> <span class="nv">_caller</span> <span class="nv">state-data</span><span class="p">)</span>
    <span class="o">`#(</span><span class="nv">stop</span> <span class="nv">shutdown</span> <span class="nv">ok</span> <span class="nv">state-data</span><span class="p">))</span>
  <span class="p">((</span><span class="nv">message</span> <span class="nv">_caller</span> <span class="nv">state-data</span><span class="p">)</span>
    <span class="o">`#(</span><span class="nv">reply</span> <span class="o">,</span><span class="p">(</span><span class="nv">unknown-command</span><span class="p">)</span> <span class="o">,</span><span class="nv">state-data</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">terminate</span> <span class="p">(</span><span class="nv">_reason</span> <span class="nv">_state-data</span><span class="p">)</span>
  <span class="ss">&#39;ok</span><span class="p">)</span></code></pre></div>

<p>Note that our callback module doesn’t implement all the callbacks it would need
as part of a full-blown OTP application; we’ll do that in a future post.</p>

<h2 id="learning-more-about-genserver">Learning More About gen_server</h2>

<p>There’s a lot of information we didn’t cover in this tutorial, however it’s
enough to get started writing simple OTP servers in LFE. If you’d like to learn
more, one of the newest books out there on the topic has been recently
published by O’Reilly:
<a href="http://shop.oreilly.com/product/0636920024149.do">Designing for Scalability with Erlang/OTP</a>.
The chapter on <code>gen_server</code> covers this material in much more detail,
including timeouts, deadlocks, hibernating, and custom global registries.</p>

<p>Another good resource, once you get up to speed, is the
<a href="http://www.erlang.org/doc/man/gen_server.html">Erlang documentation</a> (and
<a href="http://www.erlang.org/doc/design_principles/gen_server_concepts.html">here</a>).
Often overlooked, it’s actually really good and will be a constant companion
for you any time you need to do something with OTP that you haven’t tried
before.</p>

<p>In future posts in this series, we will be covering bits we’ve left out of this
tutorial, namely:</p>

<ul>
  <li><code>handle_info</code> - managing unepxected messages and different error states</li>
  <li><code>code_change</code> - supporting hot-loading of code in a running system</li>
  <li><code>format_status</code> - providing custom status data for a running server</li>
</ul>

<h2 id="up-next">Up Next</h2>

<p>Before we tackle any other behaviours, we’re going to explore distributed
generic servers: running our code on multiple cores and multiple machines.</p>

<hr />

<h3 id="footnotes">Footnotes</h3>

<div class="footnotes">
  <ol>
    <li id="fn:handle-info">
      <p>If you’re curious now and want to do this the right way before
            we get around to creating a blog post for error handling and
            unexpected messages, look info the <code>handle_info</code> callback
            function for <code>gen_server</code>. A minimal use of <code>handle_info</code>
            to deal with unexpected messages would involve adding three
            pattern-matching function heads: 1) match for a normal exit
            and return your state data as <code>noreply</code>, 2) match for any
            other type of exit, log the exit reason, and return your state
            data as <code>noreply</code>, and 3) have a catch-all pattern that
            simply returns your state data as <code>noreply</code>. <a href="#fnref:handle-info" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:delayed-result">
      <p>Another way to do this would be to use <code>call</code> instead of
               <code>cast</code> and in our <code>add</code> callback function, return
               <code>(gen_server:reply from `#(reply ,state-data)) `#(noreply ,(+ 1 state-data))</code>
               This does two things: 1) sends an immediate response back to
               the caller (which which is the API function <code>add</code> in this
               case), satisfying its need for a response from the server,
               and 2) passes the new state to the next loop of the server.
               We chose to use the <code>cast</code> approach not only for
               simplicity of implementation, but to introduce the async
               capabilities of a <code>gen_server</code> implementation. <a href="#fnref:delayed-result" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:start-name">
      <p>In general, this is optional – you could use <code>start/3</code> which
           doesn’t take a name. In our case, however, we need it so that we
           can easily make calls to the <code>gen_server</code> process (and for
           that we need to register a name so the process can be looked up;
           if we didn’t do this, we’d need to keep track of the process id
           for our server). <a href="#fnref:start-name" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:via-name">
      <p>A third alternative is more rarely used in the cases where one
         need to implement a custom global registry. In that event, you
         create a 3-tuple where the second element is the name of the
         module which implements the registry functions. <a href="#fnref:via-name" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:genserver-opts">
      <p>For a list of available options, see the <a href="http://www.erlang.org/doc/man/gen_server.html#start-4">gen_server:start docs</a>. <a href="#fnref:genserver-opts" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:genserver-args">
      <p>There is no defined convention in LFE for how one defines
               module-level configuration variables or where these might
               go: you can put the data for the argument values anywhere it
               makes sense to you.  You don’t even have to define any –
               you can just pass the data as-is in the function arguments.
               However, there is a lot to be said for the readability of
               the example above :-) <a href="#fnref:genserver-args" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

    <hr>
    <div class="pagination btn-group">
      
        <a class="btn prev" href="/tutorials/2015/05/25/0929-prelude-to-otp" title="Prelude to OTP">&larr; Previous</a>
      
        <a class="btn" href="/archive.html">Archive</a>
      
        <a class="btn next disabled">Next &rarr;</a>
      
    </div>
    <hr>
    
  </div>

  <div class="span4">
    <section>
      <h4>Author</h4>
      <div class="author"><span><a href="/authors.html#Duncan McGreggor">Duncan McGreggor</a></span></div>
    </section>
    <section>
      <h4>Published</h4>
      <div class="date"><span>26 May 2015</span></div>
    </section>
    
      <section>
        <h4>Category</h4>
        <span class="category">
          tutorials
        </span>
      </section>
    
    
      <section>
        <h4>Tags</h4>
        <ul class="tag_box">
          
          


  
     
    	<li><a href="/tags.html#otp-ref">otp <span>4</span></a></li>
     
    	<li><a href="/tags.html#erlang-ref">erlang <span>30</span></a></li>
    
  



        </ul>
      </section>
    
  </div>
</div>


        </div>
      </div> <!-- /container -->

      <div class="footer-push"></div>
    </div><!--/.page-wrap -->

    <footer>
      <div class="container">
        <p>&copy; 2014-2015 LFEuminati | Alien Alliance
        </p>
      </div>
    </footer>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="/assets/themes/hooligan/js/jquery.min.js"><\/script>')</script>
    <script src="/assets/themes/hooligan/bootstrap/js/bootstrap.min.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-38274766-2', 'auto');
      ga('send', 'pageview');

    </script>
  </body>
</html>

